define(["jquery","jqueryui","core/ajax","core/str","mod_ouilforum/accessibility","mod_ouilforum/stagebutton","mod_ouilforum/toast"],function(a,b,c,d,e,f){var g={course:0,str:{},infoDialog:null,currentDialog:null,pendingAction:null,toast:null,useHTMLFallback:!1,compactMode:null},h=function(){var b=a(this);e.isWaiting(b)||(g.compactMode?(f.hasOptions()||f.setOptions(b.next(),b.closest(".stage_button_container").attr("id"),i),f.setDisplay()):(e.setWait(b,!0),i(b)))},i=function(a){var b=a.attr("data-forumid"),d=a.attr("data-actiontype"),f=c.call([{methodname:"mod_ouilforum_subscribe_forum",args:{forumid:b,subscribe:d}}]);f[0].done(function(b){e.setWait(a,!1),1==b&&j(a,"subscribe","subscribe"==d,!0)}).fail(function(b){e.setWait(a,!1),v(a,!0,"aria-label",a.attr("aria-label"))})},j=function(a,b,c,d){var h,i,j,k;c?(i=h=g.str[b+"ForumYesLabel"]+", "+g.str.enabled,j="un"+b,k="on"):(i=h=g.str[b+"ForumYesLabel"]+", "+g.str.disabled,j=b,k="off"),f.setState(a.next(),c),a.attr("data-actiontype",j).attr("data-buttonstate",k).attr("title",h),d?e.informScreenReader(a,g.str.done,i,"aria-label"):a.attr("aria-label",i)},k=function(b){var d=a("#subscribealltrigger");if(!e.isWaiting(d)){e.setWait(d,!0);var f=c.call([{methodname:"mod_ouilforum_subscribe_forums",args:{courseid:g.course,subscribe:b}}]);f[0].done(function(c){if(e.setWait(d,!1),"-1"!=c){if("0"!=c){var f=c.split(",");a.each(f,function(c,d){var e=a("#subscribeforum"+d);e.length>0&&j(e,"subscribe","subscribe"==b,!1)})}var h="subscribe"===b?g.str.subscribeForumIndexNoLabel:g.str.subscribeForumIndexYesLabel;e.informScreenReader(d,g.str.done,h,"aria-label")}else e.setWait(d,!1),v(d,!0,"aria-label",d.attr("aria-label"))}).fail(function(a){e.setWait(d,!1),v(d,!0,"aria-label",d.attr("aria-label"))})}},l=function(){var b=a(this);e.isWaiting(b)||(f.hasOptions()||f.setOptions(b.next(),b.closest(".stage_button_container").attr("id"),m),f.setDisplay())},m=function(a){e.setWait(a,!0);var b=a.attr("data-forumid"),d=a.attr("data-actiontype"),h=c.call([{methodname:"mod_ouilforum_track_forum",args:{forumid:b,track:d,inview:!1}}]);h[0].done(function(c){if(e.setWait(a,!1),0!=c.result){var h,i,j,k;"track"==d?(h=g.str.trackForumNo,i=g.str.trackForumNoLabel,j="untrack",k="on",n(b,c.unread,!0)):(h=g.str.trackForumYes,i=g.str.trackForumYesLabel,j="track",k="off",n(b,0,!1)),f.setState(a.next(),"on"==k),a.attr("data-actiontype",j).attr("data-buttonstate",k),a.find(".button_text").html(h),e.informScreenReader(a,g.str.done,i,"aria-label")}}).fail(function(b){e.setWait(a,!1),v(a,!0,"aria-label",a.attr("aria-label"))})},n=function(b,c,d){var e=a("#forumunread"+b);e.length>0&&(d?(c>0&&(c='<a href="view.php?f='+b+'">'+c+"</a>"),e.html(g.str.unreadPosts+': <span class="forumlist_number">'+c+"</span>")):e.html(""))},o=function(){g.infoDialog=a('<div id="info_dialog"></div>'),g.infoDialog.html('<div id="info_dialog_content"></div>'),g.infoDialog.dialog({dialogClass:"no-close",resizable:!1,height:"auto",minWidth:200,maxWidth:600,autoOpen:!1,modal:!0,draggable:!1,buttons:[{text:g.str.copyLinkClose,click:function(){a(this).dialog("close"),a(this).find("#info_dialog_content").html("")}}]})},p=function(){s(a(this).closest(".forum_container"),!a(this).hasClass("d_opened")),r(a(this).closest("ul"))},q=function(){var b=a(this).hasClass("d_opened"),c=b?g.str.forumInfoShowAll:g.str.forumInfoHideAll;a(this).toggleClass("d_opened").attr("title",c),a(this).closest(".forum_list_header").next("ul").find(".forum_container").each(function(){s(a(this),!b)})},r=function(b){var c=b.prev(".forum_list_header").find("button.forum_header_button"),d=0,e=0;0!=c.length&&(b.find("li .forum_body").each(function(){d++,a(this).hasClass("hidden_element")&&e++}),0==e?c.addClass("d_opened").attr("title",g.str.forumInfoHideAll):e==d&&c.removeClass("d_opened").attr("title",g.str.forumInfoShowAll))},s=function(a,b){var c,d=a.find(".forum_button"),e=a.find(".forum_body");b?(d.addClass("d_opened"),e.removeClass("hidden_element"),c=g.str.forumInfoHide):(d.removeClass("d_opened"),e.addClass("hidden_element"),c=g.str.forumInfoShow),d.attr("aria-expanded",b).attr("title",c)},t=function(a){g.compactMode!=a&&(g.compactMode=a,!a&&f.hasOptions()&&f.setDisplay(!0))},u=function(b){var d=b.attr("data-forumid");e.setWait(b,!0);var f=c.call([{methodname:"mod_ouilforum_mark_forum_read",args:{forumid:d}}]);f[0].done(function(c){e.setWait(b,!1),0!=c?(b.prev().html("0"),a("#unreadmarker"+d).remove(),b.closest(".forum_container").find(".forum_list_title a").focus(),b.remove(),e.informScreenReader(b,g.str.done,"","aria-label")):v(b,!1,"aria-label","")}).fail(function(a){e.setWait(b,!1),v(b,!0,"aria-label",b.attr("aria-label"))})},v=function(a,b,c,d){e.markActionFail(a),b&&g.toast.toast("show",g.str.fail),c&&e.informScreenReader(a,g.str.fail,d,c)},w=function(){var b=["actionsuccess","actionfail","cancel","subscribeforum:no","subscribeforum:nolabel","subscribeforum:yes","subscribeforum:yeslabel","tracking:no","tracking:nolabel","tracking:yes","tracking:yeslabel","confirm","unreadposts","markallread","foruminfohide","foruminfohideall","foruminfoshow","foruminfoshowall","subscribeforumindex:no","subscribeforumindex:nolabel","subscribeforumindex:yes","subscribeforumindex:yeslabel","trackingindex:no","trackingindex:nolabel","trackingindex:yes","trackingindex:yeslabel","enabled","disabled"],c=[];a.each(b,function(a,b){c.push({key:b,component:"ouilforum"})}),d.get_strings(c).done(function(a){g.str.done=a[0],g.str.fail=a[1],g.str.cancel=a[2],g.str.subscribeForumNo=a[3],g.str.subscribeForumNoLabel=a[4],g.str.subscribeForumYes=a[5],g.str.subscribeForumYesLabel=a[6],g.str.trackForumNo=a[7],g.str.trackForumNoLabel=a[8],g.str.trackForumYes=a[9],g.str.trackForumYesLabel=a[10],g.str.confirm=a[11],g.str.unreadPosts=a[12],g.str.markAllRead=a[13],g.str.forumInfoHide=a[14],g.str.forumInfoHideAll=a[15],g.str.forumInfoShow=a[16],g.str.forumInfoShowAll=a[17],g.str.subscribeForumIndexNo=a[18],g.str.subscribeForumIndexNoLabel=a[19],g.str.subscribeForumIndexYes=a[20],g.str.subscribeForumIndexYesLabel=a[21],g.str.trackingIndexNo=a[22],g.str.trackingIndexNoLabel=a[23],g.str.trackingIndexYes=a[22],g.str.trackingIndexYesLabel=a[23],g.str.enabled=a[26],g.str.disabled=a[27],o()})};return{init:function(b){g.course=b.course,w(),f.init(),a(".forumslist .subscribeforumbutton").click(h),a(".forumslist .trackforumbutton").click(l),a(".simpleactionmenu.subscribeallmenu a[data-action]").click(function(b){b.preventDefault(),k(a(this).attr("data-action"))}),a("#region-main").on("keyup",".quicknewdialog",function(b){27==b.keyCode&&a(this).find('button[data-action="cancel"]').click()}),a(".forum_container .forum_button").click(p),a(".forum_list_header .forum_header_button").click(q),a(".forum_unread").on("click","button",function(b){b.stopPropagation(),u(a(this))}),g.toast=a("<div></div>").appendTo("body"),g.toast.toast(),g.useHTMLFallback="text"==a('<input type="email">')[0].type,t(window.innerWidth<768),a(window).resize(function(a){t(window.innerWidth<768)})}}});